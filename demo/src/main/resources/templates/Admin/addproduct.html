<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Thêm Nhiều Sản Phẩm</title>
    <link rel="stylesheet" th:href="@{/Admin.css}" />
    <meta name="csrf-token" th:content="${_csrf.token}" />
    <meta name="csrf-header" th:content="${_csrf.headerName}" />
  </head>
  <body>
    <div th:replace="Admin/header :: Header"></div>
    <div th:replace="Admin/sidebar :: sideBar"></div>

    <div class="container" th:fragment="addProductContent">
      <h3>Thêm Nhiều Sản Phẩm</h3>
      <button type="button" class="add-product-btn" onclick="addProductRow()">
        + Thêm sản phẩm
      </button>

      <form
        id="multiProductForm"
        th:action="@{/Admin/saveMultipleProducts}"
        method="post"
        enctype="multipart/form-data"
      >
        <table id="productTable">
          <thead>
            <tr>
              <th>
                NCC
                <button
                  type="button"
                  class="add-btn"
                  onclick="openProviderModal()"
                >
                  +
                </button>
              </th>
              <th>Tên sản phẩm</th>
              <th>
                Thể loại
                <button
                  type="button"
                  class="add-btn"
                  onclick="openGenreModal()"
                >
                  +
                </button>
              </th>
              <th>Giá gốc</th>
              <th>Size & SL</th>
              <th>Mô tả</th>
              <th>Hình ảnh</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr class="product-row" style="display: none">
              <td>
                <select
                  name="providerId"
                  required
                  onchange="loadProductSuggestions(this)"
                >
                  <option value="">-- Chọn NCC --</option>
                  <option
                    th:each="p : ${providers}"
                    th:value="${p.providerId}"
                    th:text="${p.providerName}"
                  ></option>
                </select>
              </td>
              <td class="autocomplete">
                <input
                  type="text"
                  name="productName"
                  placeholder="Nhập tên..."
                  required
                  oninput="showSuggestions(this)"
                />
                <div class="autocomplete-items"></div>
              </td>
              <td>
                <select name="genreId" required>
                  <option value="">-- Chọn thể loại --</option>
                  <option
                    th:each="g : ${genres}"
                    th:value="${g.genreId}"
                    th:text="${g.genreName}"
                  ></option>
                </select>
              </td>
              <td>
                <input type="number" step="0.01" name="basisPrice" required />
              </td>
              <td>
                <div class="sizes-container">
                  <div class="size-row">
                    <input
                      type="text"
                      name="sizeName"
                      placeholder="S"
                      style="width: 40px"
                    />
                    <input
                      type="number"
                      name="quantity"
                      placeholder="0"
                      min="0"
                      style="width: 50px"
                    />
                    <button
                      type="button"
                      class="add-btn"
                      onclick="addSizeRow(this)"
                    >
                      +
                    </button>
                  </div>
                </div>
              </td>
              <td><textarea name="description" rows="2"></textarea></td>
              <td>
                <input type="file" name="images" multiple accept="image/*" />
              </td>
              <td>
                <button
                  type="button"
                  class="remove-row"
                  onclick="removeRow(this)"
                >
                  X
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <div
          id="successMessage"
          style="
            display: none;
            color: green;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
          "
        >
          Đã lưu thành công! Biên lai nhập kho đã được tạo theo nhà cung cấp.
        </div>

        <button type="button" class="submit-all" onclick="submitForm()">
          LƯU TẤT CẢ
        </button>
      </form>

      <!-- Modal NCC -->
      <div id="providerModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeModal('providerModal')">X</span>
          <h4>Thêm Nhà cung cấp</h4>
          <input
            type="text"
            id="newProviderName"
            placeholder="Tên NCC"
            required
          />
          <input type="email" id="newProviderEmail" placeholder="Email" />
          <input type="text" id="newProviderPhone" placeholder="SĐT" />
          <input type="text" id="newProviderAddress" placeholder="Địa chỉ" />
          <button type="button" onclick="saveProvider()">Lưu</button>
        </div>
      </div>

      <!-- Modal Thể loại -->
      <div id="genreModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeModal('genreModal')">X</span>
          <h4>Thêm Thể loại</h4>
          <input
            type="text"
            id="newGenre"
            placeholder="Tên thể loại"
            required
          />
          <button type="button" onclick="saveGenre()">Lưu</button>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      const productSuggestions = /*[[${productSuggestions}]]*/ {};

      function submitForm() {
        const form = document.getElementById("multiProductForm");
        let valid = true;

        document
          .querySelectorAll(
            "#productTable tbody tr:not([style*='display: none'])"
          )
          .forEach((row) => {
            const hasSize = Array.from(row.querySelectorAll(".size-row")).some(
              (sizeRow) => {
                const name = sizeRow
                  .querySelector('input[name="sizeName"]')
                  ?.value.trim();
                const qty = sizeRow.querySelector(
                  'input[name="quantity"]'
                )?.value;
                return name && qty > 0;
              }
            );
            if (!hasSize) valid = false;
          });

        if (!valid) {
          alert("Mỗi sản phẩm cần ít nhất 1 size có số lượng > 0!");
          return;
        }

        form.submit();
        document.getElementById("successMessage").style.display = "block";
      }

      // Các hàm JS: addProductRow, addSizeRow, removeRow, open/closeModal, saveProvider, saveGenre, load/showSuggestions
      // → Giữ nguyên như file trước (đã hoạt động tốt)

      function addProductRow() {
        const tbody = document.querySelector("#productTable tbody");
        const template = tbody.querySelector(".product-row").cloneNode(true);
        template.style.display = "";

        // Reset tất cả input/select
        template.querySelectorAll("input, select, textarea").forEach((el) => {
          if (el.type === "file") el.value = "";
          else if (el.tagName === "SELECT") {
            el.selectedIndex = 0; // Chọn option đầu (disabled)
          } else {
            el.value = "";
          }
        });
        // Reset size
        const container = template.querySelector(".sizes-container");
        container.innerHTML = `<div class="size-row">
          <input type="text" name="sizeName" placeholder="S" style="width:40px" />
          <input type="number" name="quantity" placeholder="0" min="0" style="width:50px" />
          <button type="button" class="add-btn" onclick="addSizeRow(this)">+</button>
        </div>`;

        tbody.appendChild(template);
      }

      function addSizeRow(btn) {
        const container = btn.closest(".sizes-container");
        const row = document.createElement("div");
        row.className = "size-row";
        row.innerHTML = `
            <input type="text" name="sizeName" placeholder="M" style="width:40px" />
            <input type="number" name="quantity" placeholder="0" min="0" style="width:50px" />
            <button type="button" class="remove-size" onclick="this.parentElement.remove()">−</button>
        `;
        container.appendChild(row);
      }
      function removeRow(btn) {
        btn.closest("tr").remove();
      }
      function openProviderModal() {
        document.getElementById("providerModal").style.display = "flex";
      }
      function openGenreModal() {
        document.getElementById("genreModal").style.display = "flex";
      }
      function closeModal(id) {
        document.getElementById(id).style.display = "none";
      }

      function getCsrfToken() {
        const token = document
          .querySelector('meta[name="csrf-token"]')
          .getAttribute("content");
        const header = document
          .querySelector('meta[name="csrf-header"]')
          .getAttribute("content");
        return { token, header };
      }

      function saveProvider() {
        const { token, header } = getCsrfToken();
        const data = {
          providerName: document.getElementById("newProviderName").value.trim(),
          providerEmail: document
            .getElementById("newProviderEmail")
            .value.trim(),
          providerPhone: document
            .getElementById("newProviderPhone")
            .value.trim(),
          providerAddress: document
            .getElementById("newProviderAddress")
            .value.trim(),
        };
        if (!data.providerName) return alert("Nhập tên NCC!");

        fetch("/Admin/addProvider", {
          method: "POST",
          headers: { "Content-Type": "application/json", [header]: token },
          body: JSON.stringify(data),
        })
          .then((r) => r.json())
          .then((p) => {
            document
              .querySelectorAll('select[name="providerId"]')
              .forEach((s) => {
                s.add(new Option(p.providerName, p.providerId));
                s.value = p.providerId;
              });
            closeModal("providerModal");
            document
              .querySelectorAll("#providerModal input")
              .forEach((i) => (i.value = ""));
          });
      }

      function saveGenre() {
        const { token, header } = getCsrfToken();
        const name = document.getElementById("newGenre").value.trim();
        if (!name) return alert("Nhập thể loại!");

        fetch("/Admin/addGenre", {
          method: "POST",
          headers: { "Content-Type": "application/json", [header]: token },
          body: JSON.stringify({ genre: name }),
        })
          .then((r) => r.json())
          .then((g) => {
            document.querySelectorAll('select[name="genreId"]').forEach((s) => {
              s.add(new Option(g.genreName, g.genreId));
              s.value = g.genreId;
            });
            closeModal("genreModal");
            document.getElementById("newGenre").value = "";
          });
      }

      function loadProductSuggestions(select) {
        const suggestions = productSuggestions[select.value] || [];
        select
          .closest("tr")
          .querySelector('input[name="productName"]').dataset.suggestions =
          JSON.stringify(suggestions);
      }

      function showSuggestions(input) {
        const suggestions = JSON.parse(input.dataset.suggestions || "[]");
        const val = input.value.toLowerCase();
        const container = input.nextElementSibling;
        container.innerHTML = "";
        if (!val) return;

        suggestions
          .filter((p) => p.productName.toLowerCase().includes(val))
          .slice(0, 5)
          .forEach((p) => {
            const div = document.createElement("div");
            div.innerHTML = `<strong>${p.productName}</strong><br><small>Mã: ${p.productId} | Giá: ${p.basisPrice}</small>`;
            div.onclick = () => {
              input.value = p.productName;
              input
                .closest("tr")
                .querySelector('select[name="genreId"]').value = p.genreId;
              input
                .closest("tr")
                .querySelector('input[name="basisPrice"]').value = p.basisPrice;
              container.innerHTML = "";
            };
            container.appendChild(div);
          });
      }

      window.onload = () => addProductRow();
    </script>

    <div th:replace="Admin/footer :: Footer"></div>
  </body>
</html>
